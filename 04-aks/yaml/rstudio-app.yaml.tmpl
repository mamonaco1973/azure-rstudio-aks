
# ==============================================================================
# StorageClass for Azure Files (NFS Protocol)
# ==============================================================================
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: azurefiles-nfs-sc
  annotations:
    storageclass.kubernetes.io/is-default-class: "false"
provisioner: file.csi.azure.com
parameters:
  skuName: Premium_LRS          # Required for NFS (Standard_LRS not supported)
  protocol: nfs                 # Use NFS instead of SMB
  encryptInTransit: "true"      # Forces CSI to use aznfs mount helper
reclaimPolicy: Retain
volumeBindingMode: Immediate
allowVolumeExpansion: true
---
# ==============================================================================
# Static PersistentVolume - Existing Azure Files NFS Share
# ==============================================================================
apiVersion: v1
kind: PersistentVolume
metadata:
  name: azurefiles-nfs-pv
spec:
  capacity:
    storage: 100Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: azurefiles-nfs-sc
  mountOptions:
    - nconnect=8
    - hard
    - timeo=600
    - retrans=2
  csi:
    driver: file.csi.azure.com
    volumeHandle: "rstudio-servers-rg#${storage_account}#nfs"
    volumeAttributes:
      shareName: nfs
      storageAccount: ${storage_account}
      protocol: nfs
---
# ==============================================================================
# PersistentVolumeClaim for Azure Files NFS PV
# ==============================================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: azurefiles-nfs-pvc
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: azurefiles-nfs-sc
  volumeName: azurefiles-nfs-pv
  resources:
    requests:
      storage: 100Gi
---
# --- Secret: RStudio Configuration -------------------------------------------
apiVersion: v1
kind: Secret
metadata:
  name: rstudio-config
type: Opaque
stringData:
  admin_secret: "admin-ad-credentials" 
  domain_fqdn: "rstudio.mikecloud.com"
  vault_name: "${vault_name}"
  netbios: "RSTUDIO"

# Notes:
# - The values here are low sensitivity; credentials are stored in an Azure Key Vault.
# - Mounted as text files inside the container (not environment variables).
---
# --- Headless Service for StatefulSet ----------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: rstudio
  labels:
    app: rstudio
spec:
  clusterIP: None
  selector:
    app: rstudio
  ports:
    - port: 8787
      name: rstudio
# Notes:
# - Enables unique, stable hostnames like rstudio-0.rstudio.<namespace>.svc.
# - Required for StatefulSet hostname resolution and AD compatibility.
---
# ==============================================================================
# StatefulSet for RStudio Server Cluster on Azure AKS
# ==============================================================================
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rstudio
  labels:
    app: rstudio
spec:
  serviceName: "rstudio"
  replicas: 2
  selector:
    matchLabels:
      app: rstudio
  template:
    metadata:
      labels:
        app: rstudio
        azure.workload.identity/use: "true"
      annotations:
        azure.workload.identity/use: "true"

    spec:
      # ----------------------------------------------------------------------
      # Node/Pod Placement Rules
      # ----------------------------------------------------------------------
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - rstudio
              topologyKey: "kubernetes.io/hostname"

      # ----------------------------------------------------------------------
      # Service Account
      # ----------------------------------------------------------------------
      serviceAccountName: keyvault-access-sa

      # ----------------------------------------------------------------------
      # Containers
      # ----------------------------------------------------------------------
      containers:
      - name: rstudio
        image: ${rstudio_image}
        ports:
        - containerPort: 8787
        resources:
          requests:
            cpu: "500m"
            memory: "500Mi"
          limits:
            cpu: "2000m"
            memory: "3000Mi"
        readinessProbe:
          httpGet:
            path: /auth-sign-in
            port: 8787
        livenessProbe:
          httpGet:
            path: /auth-sign-in
            port: 8787
        volumeMounts:
        - name: rstudio-config-vol
          mountPath: /etc/rstudio-config
        - name: azurefiles-nfs-storage
          mountPath: /nfs
        - name: azurefiles-nfs-storage
          mountPath: /home
          subPath: home

      # ----------------------------------------------------------------------
      # Volumes
      # ----------------------------------------------------------------------
      volumes:
        - name: rstudio-config-vol
          secret:
            secretName: rstudio-config
        - name: azurefiles-nfs-storage
          persistentVolumeClaim:
            claimName: azurefiles-nfs-pvc
---
# --- ClusterIP Service for External Access -------------------------------
apiVersion: v1
kind: Service
metadata:
  name: rstudio-external
  labels:
    app: rstudio
spec:
  selector:
    app: rstudio
  ports:
    - port: 8787
      targetPort: 8787
      name: rstudio
---
# ==============================================================================
# Ingress Resource for RStudio Server (HTTP Load Balancer with Stickiness)
# ==============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rstudio-ingress
  annotations:
    # --- Enable Sticky Sessions ----------------------------------------------
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/session-cookie-name: "rstudio_session"
    nginx.ingress.kubernetes.io/session-cookie-hash: "sha1"
    nginx.ingress.kubernetes.io/session-cookie-path: "/"

    # --- Backend Protocol (HTTP) ---------------------------------------------
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    nginx.ingress.kubernetes.io/rewrite-target: /

spec:
  ingressClassName: nginx
  rules:
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: rstudio-external
                port:
                  number: 8787
---
# --- Horizontal Pod Autoscaler (CPU-Based Scaling) ----------------------------
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: rstudio-hpa
  labels:
    app: rstudio
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: rstudio
  minReplicas: 2
  maxReplicas: 4
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60
# Notes:
# - HPA scales between 2â€“4 replicas based on CPU utilization.
# - Cluster Autoscaler provisions nodes if required.
# - StatefulSet ensures hostname stability and AD uniqueness.
# ==============================================================================s
